[tools]
# Outils indispensables au Cockpit
gum = "latest"      # UI Interactif
fzf = "latest"      # Recherche floue
bat = "latest"      # Cat avec syntax highlight
hk = "latest"       # Git Hooks manager
pkl = "latest"      # Config language pour hk
# nh est gÃ©rÃ© sÃ©parÃ©ment : voir la vÃ©rification dans `tasks.install`
stylua = "latest"   # Formatter Lua (Neovim)
shfmt = "latest"    # Formatter Bash
starship = "latest" # Prompt moderne
# Note: `nh` (Nix Helper) n'est pas gÃ©rÃ© automatiquement par certaines versions de Mise.
# Sa gestion est faite sÃ©parÃ©ment dans le task `install` ci-dessous (vÃ©rification/notice).

[tasks.install]
description = "Bootstrap initial post-clone"
run = """
#!/usr/bin/env bash
set -e
# 0. VÃ©rifie si 'nh' est prÃ©sent (Nix Helper)
if ! command -v nh &> /dev/null; then
  if command -v nix &> /dev/null; then
    echo "â„¹ï¸  nh non trouvÃ© â€” tentative d'installation via Nix (nix profile install nixpkgs#nh)..."
    # Tente d'installer nh dans le profile Nix de l'utilisateur
    if nix profile install nixpkgs#nh; then
      if command -v nh &> /dev/null; then
        echo "âœ… nh installÃ©"
      else
        echo "âš ï¸  L'installation de 'nh' via Nix a rÃ©ussi mais n'est pas encore disponible dans le PATH."
        echo "Vous pouvez relancer votre shell ou exÃ©cuter 'nix shell nixpkgs#nh -c nh' temporairement."
      fi
    else
      echo "âš ï¸  Ã‰chec de l'installation de 'nh' via Nix. Vous pouvez exÃ©cuter 'nix shell nixpkgs#nh -c nh' ou installer manuellement."
    fi
  else
    echo "âš ï¸  nh non trouvÃ© et Nix absent â€” installez 'nh' manuellement (ex: 'nix shell nixpkgs#nh' ou via le README)."
  fi
else
  echo "nh dÃ©tectÃ©"
fi
# 1. Installe les hooks git
hk install
# 2. Applique la config Nix initiale
./scripts/cockpit.sh --apply-only
"""

[tasks.ui]
description = "ğŸ–¥ï¸  Ouvre le Cockpit Principal"
alias = "cockpit"
run = "./scripts/cockpit.sh"

[tasks.switch]
description = "ğŸ”„ Applique la config Nix (Rebuild)"
run = "nh os switch ." # nh dÃ©tecte auto si c'est Darwin ou NixOS

[tasks.stow]
description = "ğŸ”— Applique les dotfiles (Symlinks)"
run = "./scripts/stow-apply.sh"

[tasks.save]
description = "â˜ï¸  Snapshot : Git Add + Commit + Push"
run = """
#!/usr/bin/env bash
set -e
git add .
MSG=$(gum input --placeholder "Message de commit...")
git commit -m "$MSG"
git push
"""

[tasks.gc]
description = "ğŸ§¹ Nettoyage du Store Nix"
run = "nh clean all --keep 3" # Garde les 3 derniÃ¨res gÃ©nÃ©rations

[tasks.update]
description = "â¬†ï¸  Met Ã  jour les inputs Flake + Switch"
run = """
#!/usr/bin/env bash
set -e
nix flake update
nh os switch .
"""

[tasks.edit]
description = "âœï¸  Ã‰dite une config (fuzzy finder)"
run = "./scripts/wizards/edit.sh"

[tasks.add]
description = "â• Ajoute une app/host/user"
run = "./scripts/wizards/add-app.sh"

[tasks.secret]
description = "ğŸ”’ GÃ¨re les secrets Fnox"
run = "./scripts/wizards/secret.sh"

[tasks.test-mac]
description = "ğŸ§ª Lance une VM Tart et teste l'installation complÃ¨te"
run = "./scripts/ci/test-darwin.sh"
